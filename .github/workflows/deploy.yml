name: Deploy Azure E-commerce App

on:
  push:
    branches:
      - main
      - 'feature/*'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - test
          - prod

env:
  NODE_VERSION: '18.x'
  AZURE_RESOURCE_GROUP: 'rg-ecomm-${{ github.event.inputs.environment || 'dev' }}'
  ENVIRONMENT_NAME: ${{ github.event.inputs.environment || 'dev' }}

jobs:
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            src/backend/package-lock.json
            src/frontend/package-lock.json

      # Backend tests
      - name: Install backend dependencies
        run: |
          cd src/backend
          npm ci

      - name: Lint backend code
        run: |
          cd src/backend
          npm run lint

      - name: Test backend
        run: |
          cd src/backend
          npm test

      # Frontend tests
      - name: Install frontend dependencies
        run: |
          cd src/frontend
          npm ci

      - name: Lint frontend code
        run: |
          cd src/frontend
          npm run lint

      - name: Test frontend
        run: |
          cd src/frontend
          npm test -- --coverage --watchAll=false

      - name: Build frontend
        run: |
          cd src/frontend
          npm run build

  validate-infrastructure:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate Bicep templates
        run: |
          az bicep build --file infrastructure/bicep/deploy.bicep
          az bicep build --file infrastructure/bicep/main.bicep

      - name: What-if deployment
        run: |
          az deployment sub what-if \
            --location "East US" \
            --template-file infrastructure/bicep/deploy.bicep \
            --parameters infrastructure/bicep/deploy.dev.bicepparam

  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [lint-and-test, validate-infrastructure]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    outputs:
      webAppName: ${{ steps.deploy.outputs.webAppName }}
      resourceGroupName: ${{ steps.deploy.outputs.resourceGroupName }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy infrastructure
        id: deploy
        run: |
          deployment_output=$(az deployment sub create \
            --location "East US" \
            --template-file infrastructure/bicep/deploy.bicep \
            --parameters infrastructure/bicep/deploy.dev.bicepparam \
            --query 'properties.outputs' \
            --output json)
          
          echo "webAppName=$(echo $deployment_output | jq -r '.webAppName.value')" >> $GITHUB_OUTPUT
          echo "resourceGroupName=$(echo $deployment_output | jq -r '.resourceGroupName.value')" >> $GITHUB_OUTPUT

  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: src/backend/package-lock.json

      - name: Install dependencies
        run: |
          cd src/backend
          npm ci --only=production

      - name: Create deployment package
        run: |
          cd src/backend
          zip -r ../backend-deployment.zip . -x "node_modules/.cache/*" "*.test.*" "coverage/*"

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ needs.deploy-infrastructure.outputs.webAppName }}
          resource-group-name: ${{ needs.deploy-infrastructure.outputs.resourceGroupName }}
          package: src/backend-deployment.zip
          startup-command: 'npm start'

      - name: Restart Web App
        run: |
          az webapp restart \
            --name ${{ needs.deploy-infrastructure.outputs.webAppName }} \
            --resource-group ${{ needs.deploy-infrastructure.outputs.resourceGroupName }}

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-backend]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: src/frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd src/frontend
          npm ci

      - name: Build frontend
        run: |
          cd src/frontend
          REACT_APP_API_URL=https://${{ needs.deploy-infrastructure.outputs.webAppName }}.azurewebsites.net/api npm run build

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy frontend to Static Web Apps (Alternative: Use Storage Account)
        run: |
          # For now, we'll serve the frontend from the same Web App
          # In later modules, we'll use Azure Static Web Apps or Storage Account + CDN
          echo "Frontend deployment will be enhanced in later modules"
          echo "Currently serving from the same Web App as backend"

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-backend]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Check application health
        run: |
          echo "Waiting for application to start..."
          sleep 30
          
          # Health check endpoint
          health_url="https://${{ needs.deploy-infrastructure.outputs.webAppName }}.azurewebsites.net/api/health"
          
          echo "Checking health endpoint: $health_url"
          
          # Retry logic for health check
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            if curl -f -s "$health_url" > /dev/null; then
              echo "âœ… Health check passed on attempt $attempt"
              break
            else
              echo "â³ Health check failed on attempt $attempt/$max_attempts"
              if [ $attempt -eq $max_attempts ]; then
                echo "âŒ Health check failed after $max_attempts attempts"
                exit 1
              fi
              sleep 10
              ((attempt++))
            fi
          done

  notification:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-backend, deploy-frontend, health-check]
    if: always() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
    
    steps:
      - name: Deployment Summary
        run: |
          if [[ "${{ needs.health-check.result }}" == "success" ]]; then
            echo "ğŸ‰ Deployment to ${{ env.ENVIRONMENT_NAME }} completed successfully!"
            echo "ğŸŒ Application URL: https://${{ needs.deploy-infrastructure.outputs.webAppName }}.azurewebsites.net"
            echo "ğŸ“Š Health Check: âœ… Passed"
          else
            echo "âŒ Deployment to ${{ env.ENVIRONMENT_NAME }} failed!"
            echo "Please check the logs for more details."
          fi